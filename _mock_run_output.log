====================================================================================================
SECTION 0: CONCEPT SET INVENTORY
====================================================================================================

========================================================================================================================
CONCEPT SET INVENTORY
========================================================================================================================

#    Name                                          Domain          #IDs     Used In
------------------------------------------------------------------------------------------------------------------------
1    Type 2 Diabetes Mellitus                      Condition       1        Cohort inclusion (person, measurement, drug, condition, survey SQL)
2    BMI >= 25 (Overweight/Obese)                  Measurement     1        Cohort inclusion gate (BMI >= 25)
3    Cardiovascular / Severe Conditions            Condition       8        Cohort exclusion (all SQL queries)
4    Pregnancy-Related Conditions                  Condition       3        Cohort exclusion (all SQL queries)
5    Ethnicity Exclusion (Missing/Unknown)         Person          4        Demographic exclusion (all SQL queries)
6    Race Exclusion (Missing/Unknown)              Person          4        Demographic exclusion (all SQL queries)
7    Gender Exclusion (Missing/Unknown)            Person          2        Demographic exclusion (all SQL queries)
8    Sex at Birth Exclusion (Missing/Unknown)      Person          2        Demographic exclusion (all SQL queries)
9    Insulin Therapy                               Drug            1        Drug exclusion (person, measurement, drug SQL)
10   Metformin                                     Drug            1        Exposure classification (drug SQL, treatment groups)
11   GLP-1 Receptor Agonists                       Drug            9        Exposure classification (drug SQL, treatment groups)
12   Statins (HMG-CoA Reductase Inhibitors)        Drug            8        Exposure classification (drug SQL, treatment groups)
13   Cardiometabolic Measurements (Standard)       Measurement     16       Outcome extraction (measurement SQL)
14   Cardiometabolic Measurements (Source/Non-Standard) Measurement     4        Outcome extraction fallback (measurement SQL, source concepts)
15   Body Mass Index                               Measurement     3        BMI extraction for baseline features and clustering
16   Essential Hypertension                        Condition       2        Condition query (comorbidity identification)
17   Smoking Survey Questions                      Survey          4        Smoking status derivation (survey SQL, binary covariate)
18   New Cohort Cardiometabolic Measurements       Measurement     20       Extended measurement extraction (new cohort dataset 78271067)
19   New Cohort Drug Exposure Concepts             Drug            3        Drug exposure extraction (new cohort dataset 78271067)
------------------------------------------------------------------------------------------------------------------------
Total concept sets: 19
Total unique concept IDs across all sets: see concept_ids column for details
========================================================================================================================

====================================================================================================
SECTION 1: RUNNING SQL QUERIES
====================================================================================================
Person count: 252
Measurement count: 4000
Drug exposure count: 432
Survey (smoking) rows: 252

====================================================================================================
SECTION 2: DATA PROCESSING AND TREATMENT GROUP CREATION
====================================================================================================
Cleaned measurements: 4000 (removed 0)

--------------------------------------------------------------------------------
SECTION 2A: BMI EXTRACTION CONSISTENCY AUDIT
--------------------------------------------------------------------------------

BMI extraction summary:
  Total BMI rows (after categorization): 504
  Unique patients with BMI:              252
  BMI values outside [12.0, 80.0]: 0 (already removed)
  BMI unit mismatches (unit != kg/m2): 0

  BMI by source concept_id:
    concept_id=903124 (Body mass index (BMI)): 504 rows

  BMI derivation strategy: STANDARDIZED
    Source: measurement table, concept_ids=(903124, 3038553, 40762636)
    String fallback: 'body mass index|bmi'
    Plausible range: [12.0, 80.0] kg/m2
    Expected unit: kg/m2

--------------------------------------------------------------------------------
SECTION 2B: SMOKING VARIABLE (BINARY) DERIVATION
--------------------------------------------------------------------------------

Smoking variable derivation complete:
  Total cohort patients: 252

  Smoking Status Distribution:
    Smoker         :     69 ( 27.4%)
    Non_Smoker     :    183 ( 72.6%)
    Unknown        :      0 (  0.0%)

  Survey questions used:
    concept_ids: (1585857, 1585860, 1586177, 1585855)
    Description: 1585857 = Smoking status (100 cigarettes); 1585860 = Current smoking frequency; 1586177 = Cigarette smoking status; 1585855 = Tobacco use parent question (hierarchy root for sub-questions)

  Classification rules:
    Smoker:     ANY answer NOT in ('No', 'Not at all', 'PMI: No')
    Non_Smoker: ALL answers explicitly in ('No', 'Not at all', 'PMI: No')
    Unknown:    No survey data OR all answers are skip/prefer-not-to-answer

Total users identified:
  - Statin users:       144
  - Metformin users:    144
  - GLP-1 users:        144

Treatment Groups (Mutually Exclusive):
  MONOTHERAPY:
    1. Statin only:               36
    2. Metformin only:            36
    3. GLP-1 only:                36
  DUAL THERAPY:
    4. Statin + GLP-1:            36
    5. Statin + Metformin:        36
    6. Metformin + GLP-1:         36
  TRIPLE THERAPY:
    7. Statin + GLP-1 + Met:      36

  Total unique patients:         252

Index dates computed for 252 patients

====================================================================================================
SECTION 4: CREATING PRE/POST DATASET
====================================================================================================

--------------------------------------------------------------------------------
SECTION 4A: MEASUREMENT TIMING RULES (Pre/Post Gap Enforcement)
--------------------------------------------------------------------------------

  Default minimum pre-post gap: 30 days
  Measure-specific overrides:
    HbA1c                    : 90 days
    Glucose                  : 30 days
    HDL                      : 30 days
    LDL                      : 30 days
    Total_Cholesterol        : 30 days
    Triglycerides            : 30 days
    BMI                      : 30 days

  Timing Rule Summary:
  Measure                    Total Pairs   Excluded   % Excluded   Median Gap    Min Gap
  ------------------------------------------------------------------------------------------
  Glucose                            252          0         0.0%          288         30
  HbA1c                              252          4         1.6%          224         90
  HDL                                252          0         0.0%          288         30
  LDL                                252          0         0.0%          288         30
  Total_Cholesterol                  252          0         0.0%          288         30
  Triglycerides                      252          0         0.0%          288         30
  BMI                                252          0         0.0%          288         30

  Gap Distribution (days) by Measure:
  Measure                        P10      P25   Median      P75      P90
  ------------------------------------------------------------
  Glucose                        212      250      288      324      367
  HbA1c                          125      173      224      281      316
  HDL                            212      250      288      324      367
  LDL                            212      250      288      324      367
  Total_Cholesterol              212      250      288      324      367
  Triglycerides                  212      250      288      324      367
  BMI                            212      250      288      324      367

  Pre/post pairs removed by timing rule: 4
  Pre/post pairs remaining: 1508

Complete pre/post rows: 1508
Unique patients with >=1 complete pre/post outcome: 252

Patients per group with complete pre/post data:
  Statin_mono              :     36
  Metformin_mono           :     36
  GLP1_mono                :     36
  Statin_GLP1              :     36
  Statin_Metformin         :     36
  Metformin_GLP1           :     36
  Statin_GLP1_Metformin    :     36

--------------------------------------------------------------------------------
SECTION 4B: SMOKING QA TABLE BY EXPOSURE GROUP
--------------------------------------------------------------------------------

Group                         Smoker   Non_Smoker    Unknown    Total    %Smoker
--------------------------------------------------------------------------------
Statin_mono                        7           29          0       36      19.4%
Metformin_mono                     7           29          0       36      19.4%
GLP1_mono                          6           30          0       36      16.7%
Statin_GLP1                       10           26          0       36      27.8%
Statin_Metformin                  14           22          0       36      38.9%
Metformin_GLP1                    12           24          0       36      33.3%
Statin_GLP1_Metformin             13           23          0       36      36.1%

Group                       BMI Available  BMI Missing   %Missing
-----------------------------------------------------------------
Statin_mono                            36            0       0.0%
Metformin_mono                         36            0       0.0%
GLP1_mono                              36            0       0.0%
Statin_GLP1                            36            0       0.0%
Statin_Metformin                       36            0       0.0%
Metformin_GLP1                         36            0       0.0%
Statin_GLP1_Metformin                  36            0       0.0%

====================================================================================================
NOVEL ANALYSIS 1: TREATMENT SEQUENCING / INTENSIFICATION PATTERNS
====================================================================================================

Research Question: Does the order of adding medications matter?
Clinical Relevance: Guidelines say 'start metformin first' but real-world sequencing varies.
No one has shown whether early GLP-1 initiation leads to better outcomes.

--------------------------------------------------------------------------------
1A. EXTRACTING DETAILED DRUG SEQUENCING DATA
--------------------------------------------------------------------------------

Metformin + GLP-1 Combination (36 patients):

  Sequencing Pattern Distribution:
    Metformin_First     :    36 (100.0%)

  Time to Intensification (days) by Sequence:
    Metformin_First     : Median = 108, IQR = [78, 154]

Triple Therapy (36 patients):

  Escalation Pattern Distribution:
    Stepwise_Escalation      :    36 (100.0%)

  First Drug Distribution:
    Statin                   :    33 ( 91.7%)
    Metformin                :     3 (  8.3%)

  Guideline Concordance (Metformin First):
    Concordant:         3 (8.3%)
    Non-concordant:    33 (91.7%)

  Most Common Sequence Orders:
    Statin->Metformin->GLP1       :    33 ( 91.7%)
    Metformin->Statin->GLP1       :     3 (  8.3%)

--------------------------------------------------------------------------------
1B. OUTCOMES BY TREATMENT SEQUENCING (Metformin + GLP-1 Group)
--------------------------------------------------------------------------------

Comparing outcomes by drug sequence:
Outcome              Sequence                  n        Pre       Post      Delta                 95% CI    p-value
-------------------------------------------------------------------------------------------------------------------
Glucose              Metformin_First          36     172.74     138.41     -34.37       [-41.26, -27.29]   <0.0001*
HbA1c                Metformin_First          35       9.02       7.87      -1.02         [-1.15, -0.84]   <0.0001*
HDL                  Metformin_First          36      47.50      50.73      +2.80         [-0.35, +3.76]    0.0078*
LDL                  Metformin_First          36     129.07     110.24     -16.51       [-23.90, -10.75]   <0.0001*
Total_Cholesterol    Metformin_First          36     208.89     200.06      -2.62        [-14.34, +6.34]    0.1568
Triglycerides        Metformin_First          36     228.92     220.77     -20.80       [-45.05, -10.98]   <0.0001*

  Between-Sequence Comparisons (Metformin_First vs GLP1_First):
  Outcome              n_MetFirst n_GLP1First   Delta_Diff                 95% CI    p-value
  -----------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------
1C. OUTCOMES BY ESCALATION PATTERN (Triple Therapy)
--------------------------------------------------------------------------------

A) Early Triple Therapy vs Stepwise Escalation:
Outcome              Pattern                        n        Pre       Post      Delta                 95% CI    p-value
------------------------------------------------------------------------------------------------------------------------
Glucose              Stepwise_Escalation           36     168.70     143.18     -28.11       [-37.82, -23.85]   <0.0001*
HbA1c                Stepwise_Escalation           35       9.12       8.11      -0.74         [-0.97, -0.62]   <0.0001*
HDL                  Stepwise_Escalation           36      49.25      52.21      +3.41         [+1.17, +5.42]    0.0033*
LDL                  Stepwise_Escalation           36     131.74      88.67     -42.61       [-46.24, -38.17]   <0.0001*
Total_Cholesterol    Stepwise_Escalation           36     225.00     203.46     -21.20       [-26.34, -15.24]   <0.0001*
Triglycerides        Stepwise_Escalation           36     242.73     206.21     -39.86       [-45.75, -31.58]   <0.0001*

B) Guideline Concordance (Metformin First):
Outcome                Concordant      n        Pre       Post      Delta                 95% CI    p-value
-------------------------------------------------------------------------------------------------------------------
Glucose                        No     33     175.93     149.77     -28.93       [-40.38, -25.86]   <0.0001*
HbA1c                          No     32       9.19       8.10      -0.80         [-0.97, -0.65]   <0.0001*
HDL                            No     33      49.94      52.84      +4.27         [+1.65, +5.62]    0.0010*
LDL                            No     33     131.40      92.21     -41.30       [-46.24, -34.90]   <0.0001*
Total_Cholesterol              No     33     218.73     204.68     -20.45       [-25.21, -15.24]   <0.0001*
Triglycerides                  No     33     240.78     205.75     -36.01       [-41.42, -26.27]   <0.0001*

--------------------------------------------------------------------------------
1D. SUMMARY: TREATMENT SEQUENCING PATTERNS
--------------------------------------------------------------------------------

================================================================================
KEY FINDINGS - TREATMENT SEQUENCING ANALYSIS
================================================================================

This analysis examines whether the ORDER of starting medications matters:

1. Metformin + GLP-1 Dual Therapy:
   - Compares patients who started Metformin first vs GLP-1 first vs concurrent
   - Guidelines recommend metformin as first-line, but real-world varies
   - Novel insight: Does early GLP-1 lead to better glycemic/metabolic outcomes?

2. Triple Therapy Escalation:
   - Early Triple (all 3 within 90 days) vs Stepwise Escalation
   - Guideline concordance: Was metformin started first?
   - Novel insight: Is aggressive early combination better than stepwise?

Clinical Implications:
- If GLP-1 first shows better outcomes, may challenge guidelines
- If early triple shows benefits, supports more aggressive initial therapy
- Identifies real-world prescribing patterns vs guideline recommendations


====================================================================================================
NOVEL ANALYSIS 2: TIME-TO-GLYCEMIC CONTROL (SURVIVAL ANALYSIS)
====================================================================================================

Research Question: How quickly do patients achieve HbA1c <7% across treatment groups?
Clinical Relevance: Most studies report magnitude of change, not speed.
This answers: 'How long until I see results?' - critical for patient counseling.

--------------------------------------------------------------------------------
2A. PREPARING TIME-TO-EVENT DATA
--------------------------------------------------------------------------------

Patients with baseline HbA1c >= 7% and follow-up data: 250

Distribution by treatment group:
Group                          N   Events   Event Rate   Median Time (mo)
---------------------------------------------------------------------------
Statin_mono                   35        5        14.3%                4.6
Metformin_mono                36        2         5.6%                3.9
GLP1_mono                     35       14        40.0%                4.2
Statin_GLP1                   36        7        19.4%                1.8
Statin_Metformin              36        5        13.9%                6.7
Metformin_GLP1                36       10        27.8%                4.7
Statin_GLP1_Metformin         36        7        19.4%                3.5

--------------------------------------------------------------------------------
2B. KAPLAN-MEIER SURVIVAL ANALYSIS
--------------------------------------------------------------------------------

lifelines not available - using manual Kaplan-Meier estimation

Manual Kaplan-Meier Estimates - Time to HbA1c <7%:
Group                          N   Events   Event Rate   Median Time (mo)
---------------------------------------------------------------------------
Statin_mono                   35        5        14.3%                4.6
Metformin_mono                36        2         5.6%                3.9
GLP1_mono                     35       14        40.0%                4.2
Statin_GLP1                   36        7        19.4%                1.8
Statin_Metformin              36        5        13.9%                6.7
Metformin_GLP1                36       10        27.8%                4.7
Statin_GLP1_Metformin         36        7        19.4%                3.5

--------------------------------------------------------------------------------
2C. COX PROPORTIONAL HAZARDS REGRESSION
--------------------------------------------------------------------------------

lifelines not available or insufficient data - skipping Cox regression
To enable: pip install lifelines

--------------------------------------------------------------------------------
2D. TIME-TO-GLYCEMIC CONTROL BY SEX
--------------------------------------------------------------------------------

Group                     Sex             N   Events   Event Rate    Median (mo)
-------------------------------------------------------------------------------------
Statin_mono               Male           18        3        16.7%            4.6
Statin_mono               Female         17        2        11.8%            4.6
Metformin_mono            Male           21        0         0.0%            N/A
Metformin_mono            Female         15        2        13.3%            3.9
GLP1_mono                 Male           16       10        62.5%            4.8
GLP1_mono                 Female         19        4        21.1%            3.0
Statin_GLP1               Male           15        5        33.3%            1.5
Statin_GLP1               Female         21        2         9.5%            2.4
Statin_Metformin          Male           20        2        10.0%            4.9
Statin_Metformin          Female         16        3        18.8%            7.0
Metformin_GLP1            Male           18        5        27.8%            5.2
Metformin_GLP1            Female         18        5        27.8%            4.2
Statin_GLP1_Metformin     Male           20        3        15.0%            3.5
Statin_GLP1_Metformin     Female         16        4        25.0%            5.1

================================================================================
KEY FINDINGS - TIME-TO-GLYCEMIC CONTROL ANALYSIS
================================================================================

This survival analysis answers: "How quickly do patients achieve HbA1c <7%?"

Key Metrics:
- Median time to control: Time at which 50% of patients achieve HbA1c <7%
- Event rate: Proportion achieving control during follow-up
- Hazard Ratio: Relative speed of achieving control vs reference group
  (HR > 1 = faster control, HR < 1 = slower control)

Clinical Implications:
- Helps set patient expectations ("you may see results in X months")
- Identifies which treatment strategies lead to faster glycemic control
- May influence treatment choice for patients needing rapid improvement
- Sex-stratified results show if response speed differs by sex

Novel Contribution:
- Unlike typical studies reporting final HbA1c change, this shows TRAJECTORY
- Time-to-event analysis handles patients who don't reach goal (censoring)
- Provides actionable timeline information for clinical counseling


====================================================================================================
NOVEL ANALYSIS 3: TREATMENT RESPONSE HETEROGENEITY / PHENOTYPING
====================================================================================================

Research Question: Can we identify patient phenotypes that respond differently to treatments?
Clinical Relevance: Precision medicine - 'Who benefits most from GLP-1?'
Method: Cluster patients by baseline characteristics, compare treatment responses.

--------------------------------------------------------------------------------
3A. PREPARING BASELINE FEATURE MATRIX FOR CLUSTERING
--------------------------------------------------------------------------------

Baseline features extracted for 252 patients

Feature availability:
  baseline_HbA1c           :    252 (100.0%)
  baseline_LDL             :    252 (100.0%)
  baseline_Triglycerides   :    252 (100.0%)
  baseline_HDL             :    252 (100.0%)
  baseline_Glucose         :    252 (100.0%)
  baseline_BMI             :    252 (100.0%)

--------------------------------------------------------------------------------
3B. K-MEANS CLUSTERING OF PATIENT PHENOTYPES
--------------------------------------------------------------------------------

Patients with >= 4 baseline features for clustering: 252

K-Means clustering with k=3 clusters

Cluster Distribution:
  Cluster 0:     83 ( 32.9%)
  Cluster 1:     80 ( 31.7%)
  Cluster 2:     89 ( 35.3%)

Cluster Characteristics (Median values):
Cluster         Age    HbA1c      LDL       TG      BMI
-------------------------------------------------------
  0              54.8      8.6    144.5    160.9     31.5
  1              57.5      8.4    139.9    278.4     34.3
  2              52.5      9.5    141.8    243.2     38.6

  Cluster Phenotype Interpretation:
    Cluster 0: Lower HbA1c, Lower BMI, Higher LDL
    Cluster 1: Lower HbA1c, Lower BMI, Lower LDL
    Cluster 2: High HbA1c, Higher BMI, Lower LDL

--------------------------------------------------------------------------------
3C. TREATMENT RESPONSE BY PATIENT PHENOTYPE CLUSTER
--------------------------------------------------------------------------------

Patients with cluster assignment and outcome data: 252

HbA1c Response by Cluster and Treatment Group:
Cluster    Group                          n      Pre     Post    Delta    p-value
-------------------------------------------------------------------------------------
0          Statin_mono                   13     8.63     7.99    -0.75    0.0005*
0          Metformin_mono                13     8.35     8.34    -0.25    0.0327*
0          GLP1_mono                     13     8.29     7.26    -1.07    0.0002*
0          Statin_GLP1                    7    10.14     9.19    -0.64    0.0156*
0          Statin_Metformin              17     8.37     8.16    -0.26    0.0026*
0          Metformin_GLP1                 9     9.23     7.95    -1.26    0.0039*
0          Statin_GLP1_Metformin         10     8.48     7.91    -0.51    0.0020*
1          Statin_mono                   13     8.72     8.52    -0.49    0.0171*
1          Metformin_mono                13     8.85     8.43    -0.55    0.0012*
1          GLP1_mono                     10     8.05     6.98    -0.96    0.0020*
1          Statin_GLP1                   11     7.58     7.30    -0.79    0.0010*
1          Metformin_GLP1                12     8.11     7.22    -1.01    0.0005*
1          Statin_GLP1_Metformin         15     8.63     7.82    -0.69   <0.0001*
2          Statin_mono                   10     9.38     9.04    -0.47    0.0059*
2          Metformin_mono                10     9.03     8.45    -0.28    0.0488*
2          GLP1_mono                     12     9.61     8.92    -0.69    0.0005*
2          Statin_GLP1                   18     9.18     8.53    -0.90   <0.0001*
2          Statin_Metformin              14     9.35     9.05    -0.41    0.0001*
2          Metformin_GLP1                14     9.79     8.83    -0.99    0.0001*
2          Statin_GLP1_Metformin         10     9.83     8.68    -1.01    0.0020*

--------------------------------------------------------------------------------
3D. OPTIMAL TREATMENT BY PATIENT PHENOTYPE
--------------------------------------------------------------------------------

HbA1c Reduction by Treatment Group within Each Cluster:
(More negative = better glycemic improvement)

  Cluster 0 (83 patients):
  Rank   Treatment                    HbA1c Change        n
  ------------------------------------------------------------
  1      Metformin_GLP1                      -1.26        9
  2      GLP1_mono                           -1.07       13
  3      Statin_mono                         -0.75       13
  4      Statin_GLP1                         -0.64        7
  5      Statin_GLP1_Metformin               -0.51       10
  6      Statin_Metformin                    -0.26       17
  7      Metformin_mono                      -0.25       13

  --> Best treatment for Cluster 0: Metformin_GLP1 (Delta HbA1c = -1.26)

  Cluster 1 (80 patients):
  Rank   Treatment                    HbA1c Change        n
  ------------------------------------------------------------
  1      Metformin_GLP1                      -1.01       12
  2      GLP1_mono                           -0.96       10
  3      Statin_GLP1                         -0.79       11
  4      Statin_GLP1_Metformin               -0.69       15
  5      Metformin_mono                      -0.55       13
  6      Statin_mono                         -0.49       13

  --> Best treatment for Cluster 1: Metformin_GLP1 (Delta HbA1c = -1.01)

  Cluster 2 (89 patients):
  Rank   Treatment                    HbA1c Change        n
  ------------------------------------------------------------
  1      Statin_GLP1_Metformin               -1.01       10
  2      Metformin_GLP1                      -0.99       14
  3      Statin_GLP1                         -0.90       18
  4      GLP1_mono                           -0.69       12
  5      Statin_mono                         -0.47       10
  6      Statin_Metformin                    -0.41       14
  7      Metformin_mono                      -0.28       10

  --> Best treatment for Cluster 2: Statin_GLP1_Metformin (Delta HbA1c = -1.01)


Cluster x Treatment Interaction Test:
Testing if treatment effects differ significantly across clusters

  Comparison: GLP1_mono vs Metformin_mono
  Cluster        n_G1     n_G2   Delta_G1   Delta_G2       Diff    p-value
  ---------------------------------------------------------------------------
  0                13       13      -1.07      -0.25      -0.82    0.0018*
  1                10       13      -0.96      -0.55      -0.41    0.0039*
  2                12       10      -0.69      -0.28      -0.41    0.0443*

  Comparison: Metformin_GLP1 vs Metformin_mono
  Cluster        n_G1     n_G2   Delta_G1   Delta_G2       Diff    p-value
  ---------------------------------------------------------------------------
  0                 9       13      -1.26      -0.25      -1.01    0.0011*
  1                12       13      -1.01      -0.55      -0.46    0.0012*
  2                14       10      -0.99      -0.28      -0.71    0.0038*


================================================================================
KEY FINDINGS - TREATMENT RESPONSE HETEROGENEITY ANALYSIS
================================================================================

This precision medicine analysis identifies patient phenotypes with differential treatment responses:

Methodology:
- K-means clustering on baseline characteristics (age, HbA1c, BMI, LDL, Triglycerides)
- Compared treatment response across identified phenotype clusters
- Tested for cluster x treatment interaction effects
- Note: Inflammatory biomarkers excluded per study protocol

Clinical Implications:
- Identifies which patients benefit most from GLP-1 vs Metformin
- Supports precision medicine approach to T2DM treatment selection
- Could inform clinical decision tools for personalized therapy

Novel Contribution:
- Most GLP-1 trials report average effects; this shows WHO responds best
- Phenotype-based analysis is a gap in real-world diabetes research
- Actionable insights: "Patients with profile X should consider treatment Y"


====================================================================================================
NOVEL ANALYSIS 4: DISCORDANT RESPONDERS ANALYSIS
====================================================================================================

Research Question: What characterizes patients with discordant glycemic vs lipid responses?
Clinical Relevance: Challenges assumption that metabolic improvements are uniform.
Implication: Some patients may need additional targeted therapy.

--------------------------------------------------------------------------------
4A. DEFINING RESPONSE CATEGORIES
--------------------------------------------------------------------------------

Response Definitions:
  Glycemic Responder: HbA1c change <= -0.5% (decrease of >= 0.5%)
  Lipid Responder: Post-LDL < 100 mg/dL OR LDL change <= -20 mg/dL

Patients with both HbA1c and LDL pre/post data: 248

Response Category Distribution:
Category                    N        %
----------------------------------------
Dual_Responder            114    46.0%
Glycemic_Only              56    22.6%
Lipid_Only                 54    21.8%
Non_Responder              24     9.7%

--------------------------------------------------------------------------------
4B. CHARACTERISTICS OF RESPONSE CATEGORIES
--------------------------------------------------------------------------------

Category                  N      Age    %Female   BL HbA1c     BL LDL     BL BMI
--------------------------------------------------------------------------------
Dual_Responder          114     54.9      45.6%        8.9      133.7       35.1
Glycemic_Only            56     54.3      58.9%        8.8      150.6       36.2
Lipid_Only               54     54.6      46.3%        9.0      135.3       33.5
Non_Responder            24     54.8      37.5%        8.9      149.5       36.3

--------------------------------------------------------------------------------
4C. DISCORDANT RESPONDERS BY TREATMENT GROUP
--------------------------------------------------------------------------------

Group                          N     Dual  Glyc_Only  Lipid_Only   Non_Resp
-------------------------------------------------------------------------------------
Statin_mono                   36    18 (50.0%)     3 ( 8.3%)    12 (33.3%)     3 ( 8.3%)
Metformin_mono                36     5 (13.9%)    11 (30.6%)     6 (16.7%)    14 (38.9%)
GLP1_mono                     35     9 (25.7%)    20 (57.1%)     3 ( 8.6%)     3 ( 8.6%)
Statin_GLP1                   36    30 (83.3%)     2 ( 5.6%)     3 ( 8.3%)     1 ( 2.8%)
Statin_Metformin              35    12 (34.3%)     3 ( 8.6%)    18 (51.4%)     2 ( 5.7%)
Metformin_GLP1                35    17 (48.6%)    15 (42.9%)     2 ( 5.7%)     1 ( 2.9%)
Statin_GLP1_Metformin         35    23 (65.7%)     2 ( 5.7%)    10 (28.6%)     0 ( 0.0%)

--------------------------------------------------------------------------------
4D. STATISTICAL COMPARISON OF DISCORDANT GROUPS
--------------------------------------------------------------------------------

Comparing Glycemic-Only vs Lipid-Only Responders:
  N Glycemic-Only: 56
  N Lipid-Only:    54

Characteristic               Glyc_Only   Lipid_Only      p-value
-----------------------------------------------------------------
Age (median)                      54.3         54.6      0.6756
Baseline HbA1c (median)            8.8          9.0      0.7355
Baseline LDL (median)            150.6        135.3      0.0189*
% Female                         58.9%        46.3%      0.2561

--------------------------------------------------------------------------------
4E. PREDICTORS OF DISCORDANT RESPONSE
--------------------------------------------------------------------------------

Logistic Regression: Predictors of Glycemic-Only Response (vs Dual Responder)
(Among responders to at least one domain)

Variable                        OR             95% CI      p-value
----------------------------------------------------------------------
age                           0.91 [  0.65,   1.28]      0.6056
female                        1.48 [  0.75,   2.93]      0.2567
race_black                    1.15 [  0.55,   2.44]      0.7062
Baseline hba1c                1.01 [  0.73,   1.41]      0.9417
Baseline ldl                  1.63 [  1.15,   2.30]      0.0057*
has_glp1                      0.98 [  0.48,   2.04]      0.9671

Model N = 170, Pseudo R-squared = 0.051

================================================================================
KEY FINDINGS - DISCORDANT RESPONDERS ANALYSIS
================================================================================

This analysis identifies patients with discordant glycemic vs lipid responses:

Response Categories:
- Dual Responder: Improved both HbA1c (>=0.5% decrease) AND LDL (reached goal)
- Glycemic Only: Improved HbA1c but NOT LDL - may need lipid-focused therapy
- Lipid Only: Improved LDL but NOT HbA1c - may need glycemic intensification
- Non-Responder: Neither improved - consider alternative strategies

Clinical Implications:
- Identifies patients who may benefit from additional targeted therapy
- Glycemic-only responders: Consider adding/intensifying statin therapy
- Lipid-only responders: Consider GLP-1 addition or glycemic intensification
- Characterization helps predict who will have discordant responses

Novel Contribution:
- Challenges assumption that metabolic improvements occur uniformly
- Real-world evidence for multi-dimensional treatment response
- Supports individualized approach to cardiometabolic management
- Identifies gaps between glycemic and lipid control in clinical practice


====================================================================================================
NOVEL ANALYSIS 5: GLP-1 EFFECT IN STATIN-NAIVE POPULATION
====================================================================================================

Research Question: What are the independent lipid effects of GLP-1 in statin-naive patients?
Clinical Relevance: Most GLP-1 trials have heavy statin background use.
This isolates GLP-1's independent lipid contribution - a literature gap.

--------------------------------------------------------------------------------
5A. DEFINING STATIN-NAIVE vs STATIN-EXPOSED GROUPS
--------------------------------------------------------------------------------

Lipid data available:
  Total patients: 252

Group                     Statin Status    Has GLP-1  N (lipid data)
----------------------------------------------------------------------
Statin_mono               Exposed                 No              36
Metformin_mono            Naive                   No              36
GLP1_mono                 Naive                  Yes              36
Statin_GLP1               Exposed                Yes              36
Statin_Metformin          Exposed                 No              36
Metformin_GLP1            Naive                  Yes              36
Statin_GLP1_Metformin     Exposed                Yes              36

--------------------------------------------------------------------------------
5B. LIPID OUTCOMES IN STATIN-NAIVE PATIENTS BY GLP-1 STATUS
--------------------------------------------------------------------------------

Lipid Changes in Statin-Naive Patients:
Outcome              GLP-1 Status         n        Pre       Post      Delta                 95% CI    p-value
--------------------------------------------------------------------------------------------------------------
LDL                  No GLP-1            36     152.47     147.71      -8.37        [-12.95, -3.70]   <0.0001*
LDL                  With GLP-1          72     143.24     128.51     -13.29        [-18.34, -9.57]   <0.0001*
  --> GLP-1 vs No GLP-1: Diff = -4.92 [-11.03, +1.27], p = 0.0373*

HDL                  No GLP-1            36      46.95      52.07      +4.16         [+2.99, +5.00]    0.0002*
HDL                  With GLP-1          72      48.90      51.35      +2.91         [+1.61, +3.70]   <0.0001*
  --> GLP-1 vs No GLP-1: Diff = -1.24 [-3.24, +0.28], p = 0.4209

Triglycerides        No GLP-1            36     221.46     212.96     -21.68        [-35.15, -4.62]    0.0028*
Triglycerides        With GLP-1          72     223.07     207.87     -32.49       [-44.13, -24.07]   <0.0001*
  --> GLP-1 vs No GLP-1: Diff = -10.81 [-30.74, +6.08], p = 0.0361*

Total_Cholesterol    No GLP-1            36     219.27     206.10      -9.41        [-14.23, -6.44]   <0.0001*
Total_Cholesterol    With GLP-1          72     214.04     206.76      -5.67        [-14.01, +3.35]    0.0091*
  --> GLP-1 vs No GLP-1: Diff = +3.73 [-5.47, +14.18], p = 0.2369


--------------------------------------------------------------------------------
5C. GLP-1 LIPID EFFECTS: STATIN-NAIVE vs STATIN-EXPOSED
--------------------------------------------------------------------------------

Comparing GLP-1 lipid effects by statin background:
Outcome         Population                n      Delta                 95% CI    p-value
------------------------------------------------------------------------------------------
LDL             GLP-1, No Statin         72     -13.29        [-17.71, -9.74]   <0.0001*
LDL             GLP-1 + Statin           72     -41.26       [-44.30, -38.33]   <0.0001*
  --> Difference (No Statin - With Statin): +27.97, p = <0.0001*

HDL             GLP-1, No Statin         72      +2.91         [+1.17, +3.66]   <0.0001*
HDL             GLP-1 + Statin           72      +2.95         [+1.24, +4.27]   <0.0001*
  --> Difference (No Statin - With Statin): -0.03, p = 0.8307

Triglycerides   GLP-1, No Statin         72     -32.49       [-44.13, -23.10]   <0.0001*
Triglycerides   GLP-1 + Statin           72     -35.52       [-44.58, -27.48]   <0.0001*
  --> Difference (No Statin - With Statin): +3.03, p = 0.6880

Total_Cholesterol GLP-1, No Statin         72      -5.67        [-14.00, +4.96]    0.0091*
Total_Cholesterol GLP-1 + Statin           72     -22.59       [-27.28, -18.76]   <0.0001*
  --> Difference (No Statin - With Statin): +16.91, p = <0.0001*


--------------------------------------------------------------------------------
5D. ESTIMATING GLP-1's INDEPENDENT LIPID CONTRIBUTION
--------------------------------------------------------------------------------

Method: Compare lipid changes between groups to estimate GLP-1's independent effect:
  - Statin alone effect: Statin_mono vs Metformin_mono
  - GLP-1 alone effect (statin-naive): GLP-1 containing vs Metformin_mono
  - Combination effect: Statin + GLP-1 vs Statin alone


Comparison                                    Outcome               Diff                 95% CI    p-value
--------------------------------------------------------------------------------------------------------------
Statin alone effect (vs Met)                  LDL                 -26.57 [-33.62, -17.34]   <0.0001*
GLP-1 alone effect (vs Met)                   LDL                  -1.83 [-8.37, +3.29]    0.2722
Met+GLP-1 effect (vs Met)                     LDL                  -8.14 [-16.21, -1.02]    0.0126*
Statin+GLP-1 vs Statin alone                  LDL                  -5.63 [-13.93, +2.67]    0.2175

Statin alone effect (vs Met)                  Triglycerides       +15.73 [-6.65, +31.73]    0.2217
GLP-1 alone effect (vs Met)                   Triglycerides       -17.15 [-36.90, +0.13]    0.0065*
Met+GLP-1 effect (vs Met)                     Triglycerides        +0.88 [-24.10, +17.44]    0.3706
Statin+GLP-1 vs Statin alone                  Triglycerides       -23.20 [-46.72, -2.33]    0.0157*


================================================================================
KEY FINDINGS - GLP-1 INDEPENDENT LIPID EFFECTS
================================================================================

This analysis isolates GLP-1's independent lipid effects in statin-naive patients:

Key Findings Framework:
1. GLP-1 effect in statin-naive patients:
   - Compares GLP-1 users (without statins) to metformin-only users
   - Shows what lipid changes occur from GLP-1 alone

2. Comparison to statin background:
   - GLP-1 + statin vs GLP-1 alone shows added statin benefit
   - Statin + GLP-1 vs statin alone shows added GLP-1 benefit

3. Independent contribution estimates:
   - Quantifies GLP-1's lipid effect separate from statin effects
   - Important for patients who cannot tolerate statins

Clinical Implications:
- For statin-intolerant patients: GLP-1 may provide some lipid benefit
- GLP-1's triglyceride-lowering effect may be independent of statins
- Combination therapy (statin + GLP-1) may provide additive benefits
- Supports GLP-1 use in patients with residual dyslipidemia on statins

Novel Contribution:
- Most GLP-1 trials include patients on background statins
- This isolates GLP-1's independent lipid contribution
- Fills literature gap on GLP-1 lipid effects without statin confounding
- Clinically relevant for statin-intolerant/statin-naive populations


====================================================================================================
NOVEL ANALYSIS 6: SKIPPED -- INFLAMMATORY BIOMARKERS EXCLUDED
====================================================================================================

This analysis has been removed because inflammatory biomarkers (CRP, ESR, Fibrinogen)
are excluded from the concept set inventory per study protocol.
The original analysis stratified patients by baseline CRP and tested whether
GLP-1's anti-inflammatory properties benefit high-CRP patients more.


====================================================================================================
NOVEL ANALYSIS 7: THERAPEUTIC INERTIA ANALYSIS
====================================================================================================

Research Question: How long do patients stay on suboptimal therapy before intensification?
Clinical Relevance: Therapeutic inertia is a known barrier to diabetes management.
Health Equity Angle: Understudied in diverse populations.

--------------------------------------------------------------------------------
7A. IDENTIFYING TREATMENT INTENSIFICATION PATTERNS
--------------------------------------------------------------------------------

Patients with drug history data: 252

Number of Drug Classes Used:
  1 class   :    108 ( 42.9%)
  2 class es:    108 ( 42.9%)
  3 class es:     36 ( 14.3%)

--------------------------------------------------------------------------------
7B. TIME TO TREATMENT INTENSIFICATION
--------------------------------------------------------------------------------

Patients who intensified therapy: 144

Time to Intensification (First Drug -> Last Added Drug):
  Median: 4.2 months
  Mean:   4.2 months
  IQR:    [2.9, 5.3] months

Time to Intensification Distribution:
  <3 mo     :     39 ( 27.1%)
  3-6 mo    :     89 ( 61.8%)
  6-12 mo   :     16 ( 11.1%)
  1-2 yr    :      0 (  0.0%)
  >2 yr     :      0 (  0.0%)

--------------------------------------------------------------------------------
7C. GLYCEMIC CONTROL WHILE ON SUBOPTIMAL THERAPY
--------------------------------------------------------------------------------

Patients with HbA1c data during monotherapy period: 81

Therapeutic Inertia (HbA1c >=7% for >6 months on monotherapy):
  Patients with inertia: 1 (1.2%)
  Mean time on suboptimal mono: 6.0 months
  Mean HbA1c during inertia period: 8.2%

--------------------------------------------------------------------------------
7D. PREDICTORS OF THERAPEUTIC INERTIA
--------------------------------------------------------------------------------

Therapeutic Inertia by Demographics:

  By Sex:
    Male      : Inertia rate = 0.0%, Median time on mono = 4.3 mo (n=40)
    Female    : Inertia rate = 2.4%, Median time on mono = 4.1 mo (n=41)
    Male vs Female inertia rate: p = 1.0000

  By Race:
    White          : Inertia rate = 0.0%, Median time on mono = 3.4 mo (n=37)
    Black or Africa: Inertia rate = 0.0%, Median time on mono = 4.7 mo (n=24)

--------------------------------------------------------------------------------
7E. TIME TO INTENSIFICATION BY DEMOGRAPHICS
--------------------------------------------------------------------------------

Time to Intensification (months) by Demographics:

  By Sex:
  Sex               N     Median                  IQR
  -------------------------------------------------------
  Male             73        4.4 [3.0, 5.4]
  Female           71        4.1 [2.8, 5.1]
  Male vs Female: p = 0.6104

  By Race:
  Race                             N     Median                  IQR
  ----------------------------------------------------------------------
  White                           67        4.2 [2.9, 5.3]
  Black or African American       41        4.7 [3.5, 5.6]
  Asian                           17        3.7 [2.2, 5.2]

================================================================================
KEY FINDINGS - THERAPEUTIC INERTIA ANALYSIS
================================================================================

This analysis examines therapeutic inertia in diabetes management:

Definition:
- Therapeutic Inertia: Failure to intensify therapy despite suboptimal control
- Measured as: HbA1c >=7% for >6 months on monotherapy before adding second agent

Key Metrics:
- Time to intensification: How long patients stay on single-agent therapy
- Proportion with inertia: % of patients with prolonged suboptimal control
- Demographic patterns: Differences by sex, race in intensification timing

Clinical Implications:
- Identifies systemic delays in treatment intensification
- May reveal health equity gaps if certain groups experience more inertia
- Supports interventions targeting timely treatment escalation
- Quantifies the real-world gap between guidelines and practice

Novel Contribution:
- Therapeutic inertia is understudied in diverse, real-world populations
- All of Us data enables analysis across demographic groups
- Health equity angle: Do certain groups experience more delayed care?
- Actionable: Identifies patients at risk for delayed intensification

/Users/jcbn/Library/Python/3.9/lib/python/site-packages/statsmodels/discrete/discrete_model.py:227: PerfectSeparationWarning: Perfect separation or prediction detected, parameter may not be identified
  warnings.warn(msg, category=PerfectSeparationWarning)
/Users/jcbn/Library/Python/3.9/lib/python/site-packages/statsmodels/discrete/discrete_model.py:227: PerfectSeparationWarning: Perfect separation or prediction detected, parameter may not be identified
  warnings.warn(msg, category=PerfectSeparationWarning)
[WARNING] Standard propensity model failed (Singular matrix). Falling back to regularized fit.

====================================================================================================
PART 2: BIAS CHECKS & COHORT VALIDITY
====================================================================================================

--------------------------------------------------------------------------------
A) IMMORTAL TIME BIAS DIAGNOSTICS
--------------------------------------------------------------------------------
Group                            N  Mean IT(days)  Median IT(days)     % IT>0
--------------------------------------------------------------------------------
GLP1_mono                       36            0.0              0.0       0.0%
Metformin_GLP1                  36          114.6            107.5     100.0%
Metformin_mono                  36            0.0              0.0       0.0%
Statin_GLP1                     36          114.8            109.5     100.0%
Statin_GLP1_Metformin           36          177.8            169.5     100.0%
Statin_Metformin                36          104.3            106.0     100.0%
Statin_mono                     36            0.0              0.0       0.0%

Immortal time detected in at-risk combination groups: YES
Landmark correction applied: fixed 90-day alignment from first observed exposure
Patients changing exposure group after alignment: 105 / 252

--------------------------------------------------------------------------------
B) LEFT CENSORING / TRIPLE THERAPY EXPOSURE VALIDITY
--------------------------------------------------------------------------------
Original triple-therapy cohort size: 36

Lookback      Triple Retained   Potential LC   % Reclassified    HbA1c pairs
--------------------------------------------------------------------------------
90                          0             36           100.0%              0
180                         0             36           100.0%              0
365                         0             36           100.0%              0
730                         0             36           100.0%              0

--------------------------------------------------------------------------------
C) HbA1c MEASUREMENT FREQUENCY BIAS
--------------------------------------------------------------------------------
Group                           N   Med Pre   Med Post     Pre %    Post %   Pre+Post %
-------------------------------------------------------------------------------------
GLP1_mono                      36       1.0        4.0    100.0%    100.0%       100.0%
Metformin_GLP1                 36       1.0        4.0    100.0%    100.0%       100.0%
Metformin_mono                 36       1.0        2.0    100.0%    100.0%       100.0%
Statin_GLP1                    36       1.0        4.0    100.0%    100.0%       100.0%
Statin_GLP1_Metformin          36       1.0        4.0    100.0%    100.0%       100.0%
Statin_Metformin               36       1.0        1.5    100.0%    100.0%       100.0%
Statin_mono                    36       1.0        2.0    100.0%    100.0%       100.0%

Mitigation strategy applied: inverse-intensity weighting + restricted comparable intensity (1-6 HbA1c measures)
Scenario                                      Group                          n   Median Delta   Mean Delta
--------------------------------------------------------------------------------------------------------------
Unweighted                                    Statin_mono                   36         -0.546       -0.536
Inverse_Intensity_Weighted                    Statin_mono                   36         -0.546       -0.540
Unweighted                                    Metformin_mono                36         -0.290       -0.383
Inverse_Intensity_Weighted                    Metformin_mono                36         -0.290       -0.376
Unweighted                                    GLP1_mono                     35         -0.899       -0.902
Inverse_Intensity_Weighted                    GLP1_mono                     35         -0.899       -0.898
Unweighted                                    Statin_GLP1                   36         -0.775       -0.815
Inverse_Intensity_Weighted                    Statin_GLP1                   36         -0.775       -0.823
Unweighted                                    Statin_Metformin              35         -0.346       -0.422
Inverse_Intensity_Weighted                    Statin_Metformin              35         -0.346       -0.417
Unweighted                                    Metformin_GLP1                35         -1.020       -1.013
Inverse_Intensity_Weighted                    Metformin_GLP1                35         -1.020       -1.009
Unweighted                                    Statin_GLP1_Metformin         35         -0.743       -0.788
Inverse_Intensity_Weighted                    Statin_GLP1_Metformin         35         -0.743       -0.807
Restricted_Comparable_Intensity_1_to_6        Statin_mono                   36         -0.546       -0.536
Restricted_Comparable_Intensity_1_to_6        Metformin_mono                36         -0.290       -0.383
Restricted_Comparable_Intensity_1_to_6        GLP1_mono                     35         -0.899       -0.902
Restricted_Comparable_Intensity_1_to_6        Statin_GLP1                   36         -0.775       -0.815
Restricted_Comparable_Intensity_1_to_6        Statin_Metformin              35         -0.346       -0.422
Restricted_Comparable_Intensity_1_to_6        Metformin_GLP1                35         -1.020       -1.013
Restricted_Comparable_Intensity_1_to_6        Statin_GLP1_Metformin         35         -0.743       -0.788

==========================================================================================
BIAS & VALIDITY REPORT
==========================================================================================

A) Immortal Time Bias
- Assessment: Detected (combination-group IT>0 rate: 100.0%).
- Fix implemented: Landmark time-zero alignment at 90 days from first observed exposure.
- Impact: 105 of 252 patients changed exposure group after alignment.
- Diagnostics exported: /Users/jcbn/Desktop/CODEX/immortal_time_diagnostics.csv

B) Left Censoring / Triple Therapy Misclassification
- Assessment: evaluated observable lookback before first observed exposure.
- Triple-therapy reclassification at 365-day lookback: 100.0% potentially left-censored.
- Sensitivity implemented with alternative lookback windows: 90, 180, 365, 730 days.
- Diagnostics exported: /Users/jcbn/Desktop/CODEX/left_censoring_sensitivity.csv

C) HbA1c Frequency / Measurement Bias
- Assessment: median total HbA1c count varied by 2.5 across groups.
- Mitigation implemented: inverse-intensity weighting and restricted comparable-intensity analysis.
- Reported results include unweighted and mitigated estimates.
- Diagnostics exported: /Users/jcbn/Desktop/CODEX/hba1c_frequency_diagnostics.csv
- Mitigation results exported: /Users/jcbn/Desktop/CODEX/hba1c_frequency_mitigation_results.csv

Bias checks complete.

Bias report saved to: /Users/jcbn/Desktop/CODEX/bias_validity_report.txt

====================================================================================================
PART 3: CONFUNDING, REGRESSION, FDR, MISSINGNESS, PERFORMANCE, ASCVD RF
====================================================================================================

--------------------------------------------------------------------------------
PART 3A: CONFOUNDING BY INDICATION (PROPENSITY WEIGHTING + BALANCE)
--------------------------------------------------------------------------------
Optimization terminated successfully    (Exit mode 0)
            Current function value: 0.0022350922998053955
            Iterations: 344
            Function evaluations: 353
            Gradient evaluations: 344
Covariate                             |SMD| before   |SMD| after   Improved
------------------------------------------------------------------------------
pre_measure_count                            0.000         1.897      False
pre_drug_exposure_count                      1.109         1.109       True
/Users/jcbn/Library/Python/3.9/lib/python/site-packages/statsmodels/genmod/generalized_linear_model.py:1342: PerfectSeparationWarning: Perfect separation or prediction detected, parameter may not be identified
  warnings.warn(msg, category=PerfectSeparationWarning)
/Users/jcbn/Library/Python/3.9/lib/python/site-packages/statsmodels/genmod/generalized_linear_model.py:1342: PerfectSeparationWarning: Perfect separation or prediction detected, parameter may not be identified
  warnings.warn(msg, category=PerfectSeparationWarning)
/Users/jcbn/Library/Python/3.9/lib/python/site-packages/statsmodels/genmod/generalized_linear_model.py:1342: PerfectSeparationWarning: Perfect separation or prediction detected, parameter may not be identified
  warnings.warn(msg, category=PerfectSeparationWarning)
statin_exposure                              0.343         0.343      False
metformin_exposure                           0.343         0.343      False
baseline_Triglycerides                       0.245         0.245       True
baseline_HbA1c                               0.173         0.173      False
baseline_hyperlipidemia                      0.168         0.168      False
sex_at_birth_Male                            0.153         0.153      False
race3_Black                                  0.122         0.122       True
age_at_index                                 0.100         0.100       True
baseline_LDL                                 0.095         0.095      False
smoker_binary                                0.057         0.057       True
baseline_BMI                                 0.049         0.049      False
race3_White                                  0.047         0.047      False
pre_survey_count                             0.000         0.000      False

Sample size diagnostics:
  Initial cohort: N=252, GLP1=144, non-GLP1=108
  Propensity model sample: N=252, GLP1=144, non-GLP1=108

--------------------------------------------------------------------------------
PART 3B: ADJUSTED MODELS (ANCOVA + LOGISTIC, ROBUST SE)
--------------------------------------------------------------------------------

--------------------------------------------------------------------------------
PART 3C: MULTIPLE TESTING CONTROL (BENJAMINI-HOCHBERG FDR)
--------------------------------------------------------------------------------
Family                   Outcome                        Model                             p_raw    q_value   q<0.05
----------------------------------------------------------------------------------------------------------------------
continuous_ancova        Glucose                        Unweighted_ANCOVA_HC3          5.06e-07  1.518e-06     True
continuous_ancova        Glucose                        IPTW_ANCOVA_HC3                4.51e-07  1.518e-06     True
continuous_ancova        HbA1c                          Unweighted_ANCOVA_HC3         2.395e-18  2.628e-17     True
continuous_ancova        HbA1c                          IPTW_ANCOVA_HC3               4.379e-18  2.628e-17     True
continuous_ancova        HDL                            Unweighted_ANCOVA_HC3            0.5682     0.5733    False
continuous_ancova        HDL                            IPTW_ANCOVA_HC3                  0.5733     0.5733    False
continuous_ancova        LDL                            Unweighted_ANCOVA_HC3           0.05635    0.06819    False
continuous_ancova        LDL                            IPTW_ANCOVA_HC3                 0.05682    0.06819    False
continuous_ancova        Total_Cholesterol              Unweighted_ANCOVA_HC3          0.008756    0.01408     True
continuous_ancova        Total_Cholesterol              IPTW_ANCOVA_HC3                0.009388    0.01408     True
continuous_ancova        Triglycerides                  Unweighted_ANCOVA_HC3         2.705e-05  5.426e-05     True
continuous_ancova        Triglycerides                  IPTW_ANCOVA_HC3               2.713e-05  5.426e-05     True
interaction_tests        HbA1c                          IPTW_Interaction_glp1_exposure:C(race3)[T.Black]    0.07316     0.1463    False
interaction_tests        HbA1c                          IPTW_Interaction_glp1_exposure:C(race3)[T.White]    0.05809     0.1463    False
interaction_tests        LDL                            IPTW_Interaction_glp1_exposure:C(race3)[T.Black]     0.8337     0.8337    False
interaction_tests        LDL                            IPTW_Interaction_glp1_exposure:C(race3)[T.White]     0.6589     0.8337    False
binary_logistic          hba1c_control_post             IPTW_Logistic_HC3                     1          1    False
binary_logistic          ldl_control_post               IPTW_Logistic_HC3                0.9492          1    False
binary_logistic          hyperlipidemia_resolved_post   IPTW_Logistic_HC3                     1          1    False

--------------------------------------------------------------------------------
PART 3D: MISSING DATA MECHANISM CHECKS
--------------------------------------------------------------------------------
Outcome              Group                            N   Post missing %
------------------------------------------------------------------------
HbA1c                GLP1_mono                       36             0.0%
HbA1c                Metformin_GLP1                  36             0.0%
HbA1c                Metformin_mono                  36             0.0%
HbA1c                Statin_GLP1                     36             0.0%
HbA1c                Statin_GLP1_Metformin           36             0.0%
HbA1c                Statin_Metformin                36             0.0%
HbA1c                Statin_mono                     36             0.0%
LDL                  GLP1_mono                       36             0.0%
LDL                  Metformin_GLP1                  36             0.0%
LDL                  Metformin_mono                  36             0.0%
LDL                  Statin_GLP1                     36             0.0%
LDL                  Statin_GLP1_Metformin           36             0.0%
LDL                  Statin_Metformin                36             0.0%
LDL                  Statin_mono                     36             0.0%
Triglycerides        GLP1_mono                       36             0.0%
Triglycerides        Metformin_GLP1                  36             0.0%
Triglycerides        Metformin_mono                  36             0.0%
Triglycerides        Statin_GLP1                     36             0.0%
Triglycerides        Statin_GLP1_Metformin           36             0.0%
Triglycerides        Statin_Metformin                36             0.0%
Triglycerides        Statin_mono                     36             0.0%
Total_Cholesterol    GLP1_mono                       36             0.0%
Total_Cholesterol    Metformin_GLP1                  36             0.0%
Total_Cholesterol    Metformin_mono                  36             0.0%
Total_Cholesterol    Statin_GLP1                     36             0.0%
Total_Cholesterol    Statin_GLP1_Metformin           36             0.0%
Total_Cholesterol    Statin_Metformin                36             0.0%
Total_Cholesterol    Statin_mono                     36             0.0%

--------------------------------------------------------------------------------
PART 3E: ASCVD RISK-FACTOR STATUS & SUBGROUP STRUCTURE
--------------------------------------------------------------------------------
GLP1   Hispanic       Race3      Sex               N    Smoke%   HL pre%   HL post%   DM ctrl%
----------------------------------------------------------------------------------------------------
0      Hispanic       All_Other  Female           17     29.4%    100.0%      88.2%      25.0%
0      Hispanic       All_Other  Male             19     21.1%    100.0%      84.2%       5.3%
0      Hispanic       Black      Female           12     25.0%    100.0%     100.0%       8.3%
0      Hispanic       Black      Male             13     15.4%    100.0%      84.6%       7.7%
0      Hispanic       White      Female           19     15.8%    100.0%      89.5%      10.5%
0      Hispanic       White      Male             28     39.3%    100.0%      89.3%      10.7%
1      Hispanic       All_Other  Female           19     36.8%     94.7%      94.7%       5.3%
1      Hispanic       All_Other  Male             18      5.6%    100.0%      94.4%      55.6%
1      Hispanic       Black      Female           27     25.9%    100.0%      88.9%      11.1%
1      Hispanic       Black      Male             14     50.0%    100.0%     100.0%      21.4%
1      Hispanic       White      Female           29     20.7%    100.0%      96.6%      23.1%
1      Hispanic       White      Male             37     35.1%     97.3%      86.5%      13.5%

--------------------------------------------------------------------------------
PART 3F: BOOTSTRAP & WILCOXON RATIONALE (SENSITIVITY ONLY)
--------------------------------------------------------------------------------

==========================================================================================
BOOTSTRAP & WILCOXON RATIONALE
==========================================================================================
Primary inference strategy updated:
- Use adjusted ANCOVA/logistic models with robust standard errors as primary inference.
- Use propensity-weighted models for confounding-by-indication adjustment.
- Retain nonparametric testing only as sensitivity checks for key outcomes (HbA1c, LDL).
Rationale:
- Bootstrap/Wilcoxon are useful for robustness but computationally heavy and do not adjust confounding.
- Adjusted regression provides effect estimates with covariate control and interpretable CIs.

Performance notes:
  - Covariate cache build: 0.01s | Vectorized groupby/pivot cache replaces repeated per-patient extraction loops in inferential modules.
  - Propensity + balance diagnostics: 0.06s | Computed IPTW and SMDs with vectorized matrix operations and cached covariate design.
  - Adjusted model fitting: 0.12s | Primary inference switched to adjusted ANCOVA/logistic with robust SE; weighted models use IPTW.
  - Missingness diagnostics: 0.01s | Vectorized missing-indicator creation and grouped logistic models across outcomes.
  - ASCVD risk factor and subgroup analyses: 0.03s | Added Hispanic vs non-Hispanic and White vs Black vs All_Other subgroup structure.
  - Total Part 3 runtime: 0.25s | End-to-end time for confounding/modeling/FDR/missingness/ASCVD modules.

==========================================================================================
PART 3 REPORT: VALIDITY + EFFICIENCY + ASCVD RF
==========================================================================================
A) Confounding by indication:
- Propensity IPTW with balance diagnostics saved to /Users/jcbn/Desktop/CODEX/confounding_balance_table.csv
- Sample size / effective N diagnostics saved to /Users/jcbn/Desktop/CODEX/confounding_sample_size_diagnostics.csv
B) Regression/ANCOVA:
- Continuous ANCOVA results saved to /Users/jcbn/Desktop/CODEX/ancova_adjusted_results.csv
- Binary logistic results saved to /Users/jcbn/Desktop/CODEX/logistic_adjusted_results.csv
C) Multiple testing:
- BH-FDR outputs (raw p, q, q<0.05) saved to /Users/jcbn/Desktop/CODEX/fdr_results.csv
D) Missingness mechanism:
- Missingness rates saved to /Users/jcbn/Desktop/CODEX/missingness_rates_by_group.csv
- Missingness models saved to /Users/jcbn/Desktop/CODEX/missingness_model_results.csv
E) ASCVD risk-factor emphasis and subgroup structure:
- RF status tables saved to /Users/jcbn/Desktop/CODEX/ascvd_risk_factor_status.csv
- Subgroup model outputs saved to /Users/jcbn/Desktop/CODEX/subgroup_model_results.csv
- Inertia subgroup outputs saved to /Users/jcbn/Desktop/CODEX/inertia_subgroup_results.csv
F) Efficiency and sensitivity:
- Performance notes saved to /Users/jcbn/Desktop/CODEX/performance_notes.csv
- Bootstrap/Wilcoxon rationale saved to /Users/jcbn/Desktop/CODEX/bootstrap_wilcoxon_rationale.txt
- Nonparametric sensitivity results saved to /Users/jcbn/Desktop/CODEX/nonparametric_sensitivity_results.csv

Part 3 report saved to: /Users/jcbn/Desktop/CODEX/part3_validity_performance_report.txt

====================================================================================================
ANALYSIS COMPLETE - NOVEL ANALYSES SUMMARY
====================================================================================================

This comprehensive analysis file includes 7 NOVEL RESEARCH ANALYSES
plus PART 2 BIAS & COHORT VALIDITY checks and PART 3 validity/performance upgrades:

PART 1 ENHANCEMENTS (Data Definitions & Extraction Consistency):
A) Centralized concept sets (concept_sets.py) with inventory table
B) Standardized BMI extraction with validation checks
C) Binary smoking variable from survey data with QA table
D) Measurement timing rules (minimum pre/post gap enforcement)
   - Inflammatory biomarkers (CRP, ESR, Fibrinogen) excluded per protocol

PART 2 BIAS & VALIDITY DELIVERABLES:
A) Immortal time bias diagnostics + landmark time-zero correction
B) Left-censoring sensitivity for triple therapy (90/180/365/730-day lookback)
C) HbA1c measurement-frequency diagnostics + mitigation analyses
Saved outputs:
- bias_validity_report.txt
- immortal_time_diagnostics.csv
- left_censoring_sensitivity.csv
- hba1c_frequency_diagnostics.csv

PART 3 VALIDITY / EFFICIENCY DELIVERABLES:
A) Confounding by indication adjustment (IPTW) + SMD balance diagnostics
B) Robust ANCOVA/logistic models with baseline adjustment
C) Benjamini-Hochberg FDR outputs (raw p, q, q<0.05)
D) Missingness mechanism models + rates by exposure group
E) ASCVD risk-factor analyses and subgroup structure:
   - Hispanic vs Non-Hispanic
   - Race: White vs Black vs All_Other
F) Performance notes + targeted nonparametric sensitivity only
Saved outputs:
- confounding_balance_table.csv
- ancova_adjusted_results.csv
- logistic_adjusted_results.csv
- fdr_results.csv
- missingness_model_results.csv
- ascvd_risk_factor_status.csv
- part3_validity_performance_report.txt

1. TREATMENT SEQUENCING / INTENSIFICATION PATTERNS
   - Does medication order matter? (Metformin first vs GLP-1 first)
   - Early triple therapy vs stepwise escalation

2. TIME-TO-GLYCEMIC CONTROL (SURVIVAL ANALYSIS)
   - How quickly do patients achieve HbA1c <7%?
   - Kaplan-Meier and Cox regression

3. TREATMENT RESPONSE HETEROGENEITY / PHENOTYPING
   - ML clustering to identify patient phenotypes
   - Who benefits most from GLP-1?

4. DISCORDANT RESPONDERS
   - Patients with glycemic but not lipid response (or vice versa)
   - Characterization of discordant response patterns

5. GLP-1 EFFECT IN STATIN-NAIVE POPULATION
   - Independent lipid effects of GLP-1 without statin confounding
   - Relevant for statin-intolerant patients

6. INFLAMMATORY TRAJECTORY AS PREDICTOR -- REMOVED
   - Excluded: inflammatory biomarkers not in concept set inventory

7. THERAPEUTIC INERTIA
   - Time on suboptimal therapy before intensification
   - Health equity analysis by demographics

Each analysis includes:
- Research question and clinical relevance
- Detailed statistical methodology
- Results with 95% CI and p-values
- Clinical interpretation and novel contribution


====================================================================================================
END OF ADVANCED ANALYSIS
====================================================================================================
MOCK_RUN_SUCCESS
